<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Literacy Scrollytelling – Thomas More stijl</title>

  <!-- Libraries -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/scrollama"></script>
  <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <script src="https://unpkg.com/d3-cloud/build/d3.layout.cloud.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      /* Hoofdkleuren */
      --tm-orange:#fa6432; /* PMS 2026 C */
      --tm-blue:#00283c;   /* PMS 2189 C */
      --tm-white:#ffffff;
      --tm-black:#000a1e;  /* koud zwart */
      /* Functionele grijzen */
      --tm-g1:#dee1e4;
      --tm-g2:#e8ebee;
      --tm-g3:#f2f5f8;
      /* Secundair palet voor grafieken/legendes */
      --tm-s-yellow:#ffc87d;
      --tm-s-grass:#c8e164;
      --tm-s-blue:#4bafe1;
      --tm-s-lav:#7d96e1;
      --tm-s-green:#87d278;
      --tm-s-turq:#64c8c8;
      --tm-s-purple:#967dc8;
      --tm-s-fuchsia:#c87dc8;
    }

    /* Basis */
    html, body { margin: 0; padding: 0; overflow-x: hidden; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--tm-white); color: var(--tm-black); }
    main { width: 100%; overflow: hidden; }
    h1, h2 { margin: 0 0 0.75rem 0; line-height: 1.15; }
    p { margin: 0; }

    /* Licht / Donker sectie-thema's voor leesbaarheid */
    .step.light { color: var(--tm-black); }
    .step.dark  { color: var(--tm-white); }
    .step.dark a { color: var(--tm-white); }

    /* Sections */
    section.step { position: relative; width: 100vw; min-height: 100vh; display: flex; align-items: center; justify-content: center; transition: background 0.6s ease, color 0.6s ease; box-sizing: border-box; padding: 2rem; }

    .container { display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:2rem; width:90%; max-width:1400px; text-align:center; }
    .container.two-col { display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); align-items:center; gap:2rem; }
    /* Maak scene4 iets breder voor de Sankey */
    #scene4 .container { width:96%; max-width:1600px; }

    .text { font-size:1.2rem; line-height:1.6; max-width:800px; margin:0 auto; }
    svg { width:100%; max-width:1000px; height:auto; }
    .hidden { opacity:0; transform:translateY(30px); transition:all 0.8s ease; }
    .visible { opacity:1; transform:translateY(0); }

    /* Grafiek-tekst volgt sectiekleur automatisch */
    .treemap-label, .chart-label { fill: currentColor; }

    /* Wordcloud & overlay */
    .wc-bg { position:fixed; inset:0; z-index:0; pointer-events:none; opacity:0; transition: opacity 0.6s ease; background-color: var(--tm-blue); background-image: radial-gradient(1200px 900px at 50% 30%, rgba(0,10,30,0.96) 0%, rgba(0,40,60,0.92) 40%, rgba(0,40,60,0.0) 78%); }
    .wc-bg.active { opacity:1; }

    .wordcloud { position:fixed; inset:0; overflow:hidden; pointer-events:none; z-index:1; opacity:0; transition:opacity 0.6s ease; }
    .wordcloud.active { opacity:1; }
    .wordcloud span { position:absolute; font-weight:700; opacity:0.55; transform:scale(0); transition: transform 0.3s ease, color 0.3s ease, opacity 0.3s ease; color: var(--tm-g1); user-select:none; }
    .wordcloud span.highlight { color: var(--tm-white); font-weight:800; opacity:1 !important; transform:scale(1.8); text-shadow:0 6px 24px rgba(0,0,0,0.35); }
    .wordcloud span.dim { opacity:0.18; }

    /* Scene 6: quote cards – beter contrast op licht & donker */
    #scene6 .steps6 { position:relative; z-index:2; width:100%; max-width:1100px; margin:10vh auto 20vh; padding:0 1rem; display:flex; flex-direction:column; gap:80vh; }
    #scene6 .qstep { margin:0 auto; width:min(900px, 90vw); background: linear-gradient(180deg, rgba(255,255,255,0.78), rgba(255,255,255,0.78)); border: 1px solid var(--tm-g1); border-radius: 18px; box-shadow: 0 20px 50px rgba(0,0,0,0.12); padding: clamp(1.5rem, 3vw, 3rem); font-size: clamp(1.25rem, 2.2vw, 1.75rem); line-height:1.45; text-align:center; color: var(--tm-black); opacity:0; transform: translateY(60px) scale(0.96); will-change: transform, opacity; }
    #scene6 .qstep strong { color: var(--tm-blue); }
    #scene6 .qstep.shown { opacity:1; transform: translateY(0) scale(1); }

    #scene6 .lead { position:relative; z-index:2; text-align:center; max-width:900px; margin:0 auto; padding:8vh 1rem 0; }
    #scene6 .lead h2 { font-size: clamp(1.6rem, 4vw, 2.2rem); }
    #scene6 .lead p { color: #334155; font-size: clamp(1rem, 2vw, 1.2rem); }

    /* Achtergronden per scene (afwisselend gekleurd/licht) */
    #scene1 { background: var(--tm-g3); }
    #scene2 { background: var(--tm-blue); }
    #scene3 { background: var(--tm-white); }
    #scene4 { background: var(--tm-orange); }
    #scene5 { background: var(--tm-g2); }
    #scene6 { background: var(--tm-white); }
    /* Donkere variant voor scene6 wanneer de wordcloud actief is */
    #scene6.wc-on.step { background: var(--tm-blue); color: var(--tm-white); }

    /* Kleurthema-klassers per scene voor automatische tekstcontrast */
    #scene1.step, #scene3.step, #scene5.step, #scene6.step { color: var(--tm-black); }
    #scene2.step, #scene4.step { color: var(--tm-white); }

    /* Outro overlay – contrastrijk op wit */
    #finalOverlay { position:fixed; inset:0; z-index:3; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; background: radial-gradient(1000px 800px at 50% 30%, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.0) 70%); color: var(--tm-white); }
    #finalOverlay .final-quote { max-width:min(1200px,92vw); text-align:center; font-weight:800; line-height:1.05; font-size:clamp(2rem, 8vw, 6rem); letter-spacing:-0.02em; }
    #finalOverlay .final-quote span { display:inline-block; transform-origin:center; color: var(--tm-orange); }

    /* Extra ruimte onderaan zodat laatste step triggert */
    #scene6 .steps6::after { content:""; display:block; height: 120vh; }

    /* Helper voor fancy underline animatie (scene4) */
    .fx-underline {
      background-image: linear-gradient(currentColor, currentColor);
      background-position: 0 100%;
      background-repeat: no-repeat;
      background-size: 0% 10%;
      padding-bottom: .1em;
    }
  </style>
</head>
<body>

  <!-- Wordcloud overlay -->
  <div class="wc-bg" id="wcBg" aria-hidden="true"></div>
  <div class="wordcloud" id="wordcloud"></div>
  <div id="finalOverlay" aria-hidden="true"><div class="final-quote">We gaan ermee <span>aan de slag</span>.</div></div>

  <main id="scrolly">
    <!-- Scenes 1–5 -->
    <section id="scene1" class="step light">
      <div class="container two-col">
        <div class="text hidden">
          <h1>Van afwachtend naar zelfverzekerd</h1>
          <p>In MediaGenie doorliepen <strong>201 deelnemers</strong> uit <strong>8 organisaties</strong> onze AI Fluency-workshop. In deze scrollytelling zie je waar ze startten, wat er veranderde en wat ze morgen anders doen.</p>
        </div>
        <div id="vis1" class="hidden vis-block"></div>
      </div>
    </section>

    <section id="scene2" class="step dark">
      <div class="container two-col">
        <div id="vis2" class="hidden vis-block"></div>
        <div class="text hidden">
          <h2>Wie zat er in de zaal?</h2>
          <p>Vooral nieuwsgierige ‘stiekeme superfans’ en zelfzekere ‘maximalisten’. Observeerders en underdogs waren in de minderheid; rebellen vormden een kleine maar prikkelende groep.</p>
        </div>
      </div>
    </section>

    <section id="scene3" class="step light">
      <div class="container two-col">
        <div class="text hidden">
          <h2>Comfortniveau vóór de workshop</h2>
          <p>Vooraf voelde een groot deel zich afwachtend of onzeker om Generatieve AI te gebruiken. Slechts enkelen noemden zich comfortabel—een signaal dat praktische handvaten nodig waren.</p>
        </div>
        <div id="vis3" class="hidden vis-block"></div>
      </div>
    </section>

    <section id="scene4" class="step dark">
      <div class="container">
        <div class="text hidden">
          <h2>De verschuiving na de workshop</h2>
          <p>Wie onzeker of afwachtend startte, schoof vaak op richting comfortabel na de workshop.</p>
        </div>
        <div id="vis4" class="hidden vis-block"></div>
      </div>
    </section>

    <section id="scene5" class="step light">
      <div class="container two-col">
        <div id="vis5" class="hidden vis-block"></div>
        <div class="text hidden">
          <h2>Hoe werd de workshop beoordeeld?</h2>
          <p>De gemiddelde beoordeling was 4,6 sterren. Deelnemers waardeerden vooral de praktische handvaten en inspiratie.</p>
        </div>
      </div>
    </section>

    <!-- Scene 6: wordcloud + quotes -->
    <section id="scene6" class="step light">
      <div class="container" style="flex-direction:column; gap: 3rem;">
        <div class="lead hidden">
          <h2>Wat blijft hangen?</h2>
          <p>Scroll door de quotes; de relevante woorden lichten uit in de cloud op de achtergrond.</p>
        </div>

        <div class="steps6">
          <div class="qstep" data-keywords="rollen, gen ai"><p>“De vele verschillende <strong>rollen</strong> die <strong>Gen AI</strong> kan hebben.”</p></div>
          <div class="qstep" data-keywords="use cases, inspiratie"><p>“Ik vind de kaarten met <strong>use-cases</strong> superinteressant en <strong>inspirerend</strong>.”</p></div>
          <div class="qstep" data-keywords="starten"><p>“Het is vatbaar en haalbaar om te <strong>starten</strong>.”</p></div>
          <div class="qstep" data-keywords="llm’s, prompt"><p>“Fijn om eens te weten wat er achterliggend gebeurt bij <strong>LLM's</strong>. En hoe je dit alles kan sturen door de juiste <strong>prompt</strong> te definiëren.”</p></div>
          <div class="qstep" data-keywords="prompt canvas, toegankelijk"><p>“Het <strong>Prompt Canvas</strong> om een prompt te schrijven is heel <strong>toegankelijk</strong>. Hangt straks boven mijn bureau.”</p></div>
          <div class="qstep" data-keywords="tools, modellen"><p>“De verschillende <strong>tools</strong> die er zijn. De verschillende <strong>modellen</strong> die er zijn en hun specifieke voordelen.”</p></div>
          <div class="qstep qstep-final" data-keywords="aan de slag"><p>“We gaan ermee <strong>aan de slag</strong>.”</p></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // --- Scrollama (guarded) ---
    let scroller;
    if (window.scrollama) {
      scroller = scrollama();
    } else {
      // Fallback no-op scroller so the rest of the code doesn't crash
      scroller = {
        setup: () => ({ onStepEnter: () => ({}) }),
        resize: () => {}
      };
      console.warn('scrollama niet geladen – fallback ingeschakeld.');
    }

    function clearVis(id) { d3.select(id).selectAll('svg').remove(); }

    // Secundaire kleuren volgens TM-palet voor grafieken
    const TM_SECONDARY = [
      '#ffc87d', '#c8e164', '#4bafe1', '#7d96e1', '#87d278', '#64c8c8', '#967dc8', '#c87dc8',
      '#fa6432', /* oranje als accent */ '#00283c' /* blauw als accent */
    ];

    function isDarkSection(containerSelector){
      const node = d3.select(containerSelector).node();
      if(!node) return false;
      const section = node.closest('section');
      return section && section.classList.contains('dark');
    }

    // Treemap
    function drawTreemap(id, data) {
      const width = 800, height = 500;
      const svg = d3.select(id).append('svg').attr('viewBox', `0 0 ${width} ${height}`);
      const color = d3.scaleOrdinal(TM_SECONDARY);
      const root = d3.hierarchy({ children: data }).sum(d => d.value).sort((a,b)=>b.value-a.value);
      d3.treemap().size([width, height]).padding(3)(root);

      const nodes = svg.selectAll('g').data(root.leaves()).enter().append('g').attr('transform', d => `translate(${d.x0},${d.y0})`);
      nodes.append('rect')
        .attr('width', 0).attr('height', 0).attr('rx', 6)
        .attr('fill', d => color(d.data.label))
        .transition().duration(900)
        .attr('width', d => d.x1 - d.x0).attr('height', d => d.y1 - d.y0);

      nodes.append('text')
        .attr('x', 8).attr('y', 20)
        .attr('class', 'treemap-label chart-label')
        .style('font-size', d => Math.min(16, Math.max(10, (d.x1 - d.x0) / 10)) + 'px')
        .text(d => `${d.data.label} (${d.data.value})`)
        .each(function(d){
          const boxWidth = d.x1 - d.x0;
          const textLength = this.getComputedTextLength();
          if (textLength > boxWidth - 10) {
            d3.select(this).attr('y', 14).text(`${d.data.label.split(' ')[0]}… (${d.data.value})`);
          }
        });
    }

    // Donut
    function drawDonut(id, data) {
      const width = 420, height = 420, radius = Math.min(width, height) / 2;
      const svg = d3.select(id).append('svg').attr('viewBox', `0 0 ${width} ${height}`)
        .append('g').attr('transform', `translate(${width/2},${height/2})`);
      const color = d3.scaleOrdinal(TM_SECONDARY);
      const pie = d3.pie().sort(null).value(d => d.value);
      const arc = d3.arc().innerRadius(radius*0.55).outerRadius(radius);
      const arcs = svg.selectAll('path').data(pie(data)).enter().append('g');
      arcs.append('path').attr('fill', d=>color(d.data.label)).transition().duration(900)
        .attrTween('d', d => { const i=d3.interpolate({startAngle:0,endAngle:0},d); return t=>arc(i(t)); });

      const total = d3.sum(data, d=>d.value);
      const dark = isDarkSection(id);
      arcs.append('text').attr('transform', d=>`translate(${arc.centroid(d)})`).attr('text-anchor','middle')
        .style('font-size','12px').style('fill', dark ? '#ffffff' : '#000a1e')
        .text(d=>`${d.data.label} (${Math.round(d.data.value/total*100)}%)`);
    }

    // Sankey
    function drawSankey(id,nodes,links){
      clearVis(id);
      const host = d3.select(id).node();
      const hostWidth = host ? host.getBoundingClientRect().width : 1200;
      const width = Math.max(900, Math.min(1600, hostWidth));
      const height = Math.round(width * 0.5);
      const svg = d3.select(id).append('svg')
        .attr('viewBox',`0 0 ${width} ${height}`)
        .attr('preserveAspectRatio','xMidYMid meet')
        .style('width','min(96vw, 1600px)')
        .style('max-width','1600px');

      const color=d3.scaleOrdinal(TM_SECONDARY);
      const sankey=d3.sankey().nodeWidth(40).nodePadding(30).extent([[1,1],[width-1,height-6]]);
      const graph=sankey({nodes:nodes.map(d=>Object.assign({},d)),links:links.map(d=>Object.assign({},d))});
      const dark = isDarkSection(id);

      // --- Animate nodes: grow from center line to full height ---
      const node = svg.append('g').selectAll('rect').data(graph.nodes).join('rect')
        .attr('x',d=>d.x0)
        .attr('y',d=>(d.y0+d.y1)/2)           // start in the middle
        .attr('height',0)                     // grow to full
        .attr('width',d=>d.x1-d.x0)
        .attr('rx',6)
        .attr('fill',d=>color(d.name));

      node.transition().duration(1100).ease(d3.easeCubicOut)
        .attr('y',d=>d.y0)
        .attr('height',d=>d.y1-d.y0);

      // --- Animate links: draw all simultaneously and thicken to width ---
      const linkG = svg.append('g').attr('fill','none');
      const link = linkG.selectAll('path').data(graph.links).join('path')
        .attr('d',d3.sankeyLinkHorizontal())
        .attr('stroke',d=>color(d.source.name))
        .attr('stroke-opacity',0.6);

      // prepare path length + even reveal
      link.each(function(d){
        const totalLength = this.getTotalLength();
        d3.select(this)
          .attr('stroke-dasharray', `${totalLength} ${totalLength}`)
          .attr('stroke-dashoffset', totalLength)
          .attr('stroke-width', 1); // start thin
      });

      // animate all links uniformly over the same time => gelijkelijk opbouwen
      link.transition().duration(1400).ease(d3.easeCubicOut)
        .attr('stroke-dashoffset', 0)
        .attr('stroke-width', d=>Math.max(1,d.width));

      // Labels fade in after flows are visible
      svg.append('g').style('font','16px sans-serif').selectAll('text').data(graph.nodes).join('text')
        .attr('x',d=>d.x0<width/2?d.x1+10:d.x0-10)
        .attr('y',d=>(d.y1+d.y0)/2)
        .attr('text-anchor',d=>d.x0<width/2?'start':'end')
        .style('fill', dark ? '#ffffff' : '#000a1e')
        .style('opacity',0)
        .transition().delay(700).duration(600)
        .style('opacity',1)
        .tween('text', function(d){
          // optional: count up node value while labels fade in
          const sel = d3.select(this);
          const v = +d.value || 0;
          const i = d3.interpolateNumber(0, v);
          return function(t){ sel.text(`${d.name} (${Math.round(i(t))})`); };
        });
    }

    // Wordcloud utils
    if (window.gsap && window.ScrollTrigger) {
      gsap.registerPlugin(ScrollTrigger);
    } else {
      console.warn('GSAP/ScrollTrigger niet geladen – gebruik fallback animaties.');
    }
    const WORD_FREQUENCIES = {
      'prompt': 12, 'canvas': 8, 'prompts': 3, 'tips': 5, 'guide': 2, 'gids': 2,
      'context': 4, "llm’s": 9, 'ideeën': 6, 'starten': 4, 'use cases': 7, 'inspiratie': 6,
      'variëren': 2, 'rollen': 3, 'tools': 5, 'modellen': 5
    };
    const cloud = document.getElementById('wordcloud');
    let cloudBuilt = false; let reachedFinal = false;

    function buildCloudOnce() {
      if (cloudBuilt) return;
      Object.entries(WORD_FREQUENCIES).forEach(([word, freq]) => {
        const span = document.createElement('span');
        span.textContent = word;
        span.style.left = Math.random() * 90 + '%';
        span.style.top = Math.random() * 90 + '%';
        const size = 1 + (freq / 12) * 2; span.style.fontSize = size + 'rem';
        cloud.appendChild(span);
      });
      cloudBuilt = true;
    }
    function animateWord(el) { gsap.to(el, { x: 'random(-40, 40)', y: 'random(-40, 40)', opacity: 0.45 + Math.random() * 0.45, duration: 5 + Math.random() * 5, repeat: -1, yoyo: true, ease: 'sine.inOut' }); }
    function explodeWords() {
      const spans = document.querySelectorAll('.wordcloud span');
      gsap.fromTo(spans, { scale: 0, opacity: 0, y: 100 }, { scale: 1, opacity: 1, y: 0, stagger: 0.03, ease: 'back.out(2)', duration: 1.2, onComplete: () => spans.forEach(s => animateWord(s)) });
    }
    function clearHighlights() { document.querySelectorAll('.wordcloud span').forEach(s => { s.classList.remove('highlight'); s.classList.remove('dim'); }); }
    function highlightKeywords(keywordString) {
      clearHighlights();
      const keys = (keywordString || '').split(',').map(k => k.trim().toLowerCase()).filter(Boolean);
      const spans = Array.from(document.querySelectorAll('.wordcloud span'));
      const hits = new Set();
      spans.forEach(s => { const t = s.textContent.toLowerCase(); if (keys.some(k => t.includes(k))) { s.classList.add('highlight'); hits.add(s); } });
      spans.forEach(s => { if (!hits.has(s)) s.classList.add('dim'); });
      hits.forEach(h => { gsap.fromTo(h, { scale: 1.2 }, { scale: 1.8, duration: 0.4, yoyo: true, repeat: 1, ease: 'power2.out' }); });
    }

    // Fallbacks voor canvas preview
    function maybeActivateCloudFallback() {
      const s6 = document.getElementById('scene6'); if (!s6) return;
      const r = s6.getBoundingClientRect(); const vh = window.innerHeight || document.documentElement.clientHeight;
      const inViewport = (r.top < vh) && (r.bottom > 0);
      const sufficientlyInView = (r.top < vh*0.35) && (r.bottom > vh*0.65);
      const bg = document.getElementById('wcBg'); const wc = document.getElementById('wordcloud');

      if (!inViewport) {
        // Harde reset als scene6 niet zichtbaar is
        s6.classList.remove('wc-on');
        wc?.classList.remove('active');
        bg?.classList.remove('active');
        if (window.gsap) {
          gsap.to('#wordcloud', { opacity: 0, duration: 0.15, overwrite: true });
          gsap.to('#wcBg', { opacity: 0, duration: 0.15, overwrite: true });
          gsap.to('#finalOverlay', { opacity: 0, duration: 0.15, overwrite: true });
        } else {
          // Zonder GSAP: direct reset
          const el1 = document.getElementById('wordcloud'); const el2 = document.getElementById('wcBg'); const el3 = document.getElementById('finalOverlay');
          if (el1) el1.style.opacity = 0; if (el2) el2.style.opacity = 0; if (el3) el3.style.opacity = 0;
        }
        reachedFinal = false;
        return;
      }

      if (sufficientlyInView && !reachedFinal) {
        buildCloudOnce();
        s6.classList.add('wc-on');
        if (bg && !bg.classList.contains('active')) bg.classList.add('active');
        if (wc && !wc.classList.contains('active')) { wc.classList.add('active'); if (window.gsap) { explodeWords(); } }
      } else if (!sufficientlyInView && !reachedFinal) {
        s6.classList.remove('wc-on');
        wc?.classList.remove('active');
        bg?.classList.remove('active');
        if (window.gsap) {
          gsap.to('#wordcloud', { opacity: 0, duration: 0.2, overwrite: true });
          gsap.to('#wcBg', { opacity: 0, duration: 0.2, overwrite: true });
        } else {
          const el1 = document.getElementById('wordcloud'); const el2 = document.getElementById('wcBg');
          if (el1) el1.style.opacity = 0; if (el2) el2.style.opacity = 0;
        }
      }
    }
    function maybeRevealQuoteFallback() {
      const steps = document.querySelectorAll('#scene6 .qstep'); const lead = document.querySelector('#scene6 .lead'); const finalStepEl = document.querySelector('#scene6 .qstep-final'); const vh = window.innerHeight || document.documentElement.clientHeight;
      const inBand = (rect, topFrac = 0.7, bottomFrac = 0.3) => (rect.top < vh*topFrac && rect.bottom > vh*bottomFrac);
      if (lead) { const lr = lead.getBoundingClientRect(); if (inBand(lr, 0.85, 0.15)) lead.classList.add('shown'); }
      steps.forEach(el => { const r = el.getBoundingClientRect(); if (inBand(r)) { if (!el.classList.contains('shown')) { el.classList.add('shown'); const kw = el.getAttribute('data-keywords') || ''; if (window.gsap) highlightKeywords(kw); } } });
      if (finalStepEl) {
        const fr = finalStepEl.getBoundingClientRect(); const finaleVisible = (fr.bottom < vh * 0.35);
        const s6 = document.getElementById('scene6'); const sr = s6 ? s6.getBoundingClientRect() : null; const s6Visible = !!sr && sr.top < vh && sr.bottom > 0;
        if (reachedFinal && fr.top > vh*0.8) reachedFinal = false;
        if (finaleVisible || (reachedFinal && s6Visible)) {
          reachedFinal = true; if (window.gsap) { gsap.to('#wordcloud', { opacity: 0, duration: 0.4, ease: 'power2.out' }); gsap.to('#wcBg', { opacity: 0, duration: 0.4, ease: 'power2.out' }); gsap.to('#finalOverlay', { opacity: 1, duration: 0.6, ease: 'power2.out' }); } else { const el1 = document.getElementById('wordcloud'); const el2 = document.getElementById('wcBg'); const el3 = document.getElementById('finalOverlay'); if (el1) el1.style.opacity = 0; if (el2) el2.style.opacity = 0; if (el3) el3.style.opacity = 1; }
        } else if (s6Visible && !reachedFinal) {
          if (window.gsap) { gsap.to('#finalOverlay', { opacity: 0, duration: 0.3, ease: 'power2.out' }); gsap.to('#wcBg', { opacity: 1, duration: 0.3, ease: 'power2.out' }); gsap.to('#wordcloud', { opacity: 1, duration: 0.3, ease: 'power2.out' }); } else { const el3 = document.getElementById('finalOverlay'); if (el3) el3.style.opacity = 0; const el2 = document.getElementById('wcBg'); const el1 = document.getElementById('wordcloud'); if (el2) el2.style.opacity = 1; if (el1) el1.style.opacity = 1; }
        }
      }
    }

    // Reveal fallback voor alle .hidden elementen met IntersectionObserver
    (function initRevealFallback(){
      const items = Array.from(document.querySelectorAll('.hidden'));
      if (!('IntersectionObserver' in window)) {
        // Last resort: na 1s alles zichtbaar zodat je tenminste content ziet
        setTimeout(() => items.forEach(el => el.classList.add('visible')), 1000);
        return;
      }
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('visible'); io.unobserve(e.target); } });
      }, { root: null, rootMargin: '0px', threshold: 0.2 });
      items.forEach(el => io.observe(el));
    })();

    function setupScene6() {
      ScrollTrigger.create({
        trigger: '#scene6', start: 'top 70%', end: 'bottom top',
        onEnter: () => { buildCloudOnce(); document.getElementById('scene6').classList.add('wc-on'); document.getElementById('wcBg').classList.add('active'); document.getElementById('wordcloud').classList.add('active'); explodeWords(); },
        onLeave: () => { document.getElementById('scene6').classList.remove('wc-on'); document.getElementById('wordcloud').classList.remove('active'); document.getElementById('wcBg').classList.remove('active'); clearHighlights(); },
        onEnterBack: () => { document.getElementById('scene6').classList.add('wc-on'); document.getElementById('wcBg').classList.add('active'); document.getElementById('wordcloud').classList.add('active'); },
        onLeaveBack: () => { reachedFinal = false; document.getElementById('scene6').classList.remove('wc-on'); document.getElementById('wordcloud').classList.remove('active'); document.getElementById('wcBg').classList.remove('active'); clearHighlights(); }
      });
      const finalStep = document.querySelector('#scene6 .qstep-final');
      if (finalStep) {
        ScrollTrigger.create({
          trigger: finalStep, start: 'bottom 65%', end: 'bottom top',
          onEnter: () => { reachedFinal = true; gsap.to('#wordcloud', { opacity: 0, duration: 0.8, ease: 'power2.out' }); gsap.to('#wcBg', { opacity: 0, duration: 0.8, ease: 'power2.out' }); gsap.to('#finalOverlay', { opacity: 1, duration: 1.0, ease: 'power2.out' }); gsap.fromTo('#finalOverlay .final-quote span', { scale: 0.9 }, { scale: 1.05, yoyo: true, repeat: 1, duration: 0.8, ease: 'power2.inOut' }); },
          onLeaveBack: () => { reachedFinal = false; gsap.to('#finalOverlay', { opacity: 0, duration: 0.5, ease: 'power2.out' }); gsap.to('#wordcloud', { opacity: 1, duration: 0.6, ease: 'power2.out' }); gsap.to('#wcBg', { opacity: 1, duration: 0.6, ease: 'power2.out' }); }
        });
      }
      document.querySelectorAll('#scene6 .qstep').forEach(el => {
        ScrollTrigger.create({
          trigger: el, start: 'top 70%', end: 'bottom 60%',
          onEnter: () => { gsap.to(el, { opacity: 1, y: 0, scale: 1, duration: 0.6, ease: 'power3.out' }); const kw = el.getAttribute('data-keywords') || ''; highlightKeywords(kw); },
          onLeave: () => { gsap.to(el, { opacity: 0.35, duration: 0.3 }); },
          onEnterBack: () => { gsap.to(el, { opacity: 1, y: 0, scale: 1, duration: 0.4, ease: 'power3.out' }); const kw = el.getAttribute('data-keywords') || ''; highlightKeywords(kw); },
          onLeaveBack: () => { reachedFinal = false; gsap.to(el, { opacity: 0.35, duration: 0.3 }); }
        });
      });
    }

    /* ----------------------------- */
    /* Tekstanims per scene (variatie) */
    /* ----------------------------- */
    function wrapWords(el){
      if(!el || el.dataset.wrapped === '1') return [];
      const text = el.innerHTML;
      // Split op spaties maar behoud HTML tags binnen <strong> enz.
      // Eenvoudige aanpak: alleen buiten tags wrappen
      const temp = document.createElement('div');
      temp.innerHTML = text;
      const spans = [];
      function walker(node){
        if(node.nodeType === Node.TEXT_NODE){
          const parts = node.textContent.split(/(\s+)/);
          const frag = document.createDocumentFragment();
          parts.forEach(part => {
            if(/\s+/.test(part)) { frag.appendChild(document.createTextNode(part)); }
            else if(part.length){ const w = document.createElement('span'); w.className='w'; w.textContent = part; frag.appendChild(w); spans.push(w); }
          });
          node.parentNode.replaceChild(frag, node);
        } else if(node.nodeType === Node.ELEMENT_NODE){ Array.from(node.childNodes).forEach(walker); }
      }
      Array.from(temp.childNodes).forEach(walker);
      el.innerHTML = '';
      el.append(...Array.from(temp.childNodes));
      el.dataset.wrapped = '1';
      return spans;
    }

    function animateTextForSection(section){
      const id = section.id;
      const title = section.querySelector('h1, h2');
      const body = section.querySelector('.text p');

      // Veiligheidsnet: als niets te animeren, stop
      if(!title && !body) return;

      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: 'top 70%',
          end: 'bottom top',
          toggleActions: 'play reverse play reverse'
        }
      });

      // Effect-variaties per scene
      switch(id){
        case 'scene1':
          if(title) tl.from(title, { x: -80, opacity: 0, skewX: 6, filter:'blur(6px)', duration: 0.8, ease: 'power3.out' });
          if(body) tl.from(body, { y: 30, opacity: 0, duration: 0.7, ease: 'power2.out' }, '-=0.3');
          break;
        case 'scene2':
          if(title) tl.from(title, { scale: 0.85, rotation: -2, opacity: 0, duration: 0.7, ease: 'back.out(1.4)' });
          if(body){ const words = wrapWords(body); tl.from(words, { opacity: 0, x: 10, y: 8, stagger: 0.02, duration: 0.45, ease: 'power1.out' }, '-=0.2'); }
          break;
        case 'scene3':
          if(title) tl.fromTo(title, { y: -60, opacity: 0, letterSpacing: '0.2em' }, { y: 0, opacity: 1, letterSpacing: '0em', duration: 0.75, ease: 'power3.out' });
          if(body) tl.fromTo(body, { opacity: 0, filter: 'blur(12px)' }, { opacity: 1, filter: 'blur(0px)', duration: 0.7, ease: 'power2.out' }, '-=0.25');
          break;
        case 'scene4':
          if(title){ title.classList.add('fx-underline'); tl.from(title, { y: 80, scale: 0.96, opacity: 0, duration: 0.8, ease: 'power3.out' })
            .to(title, { backgroundSize: '100% 10%', duration: 0.6, ease: 'power2.out' }, '-=0.4'); }
          if(body) tl.from(body, { x: -40, opacity: 0, duration: 0.65, ease: 'power2.out' }, '-=0.4');
          break;
        case 'scene5':
          if(title) tl.from(title, { x: 80, opacity: 0, duration: 0.7, ease: 'power3.out' });
          if(body){ const words = wrapWords(body); tl.from(words, { opacity: 0, y: 18, stagger: 0.018, duration: 0.4, ease: 'power1.out' }, '-=0.2'); }
          break;
        case 'scene6':
          // Lead-tekst een zachte fade-up
          const leadH = section.querySelector('.lead h2');
          const leadP = section.querySelector('.lead p');
          if(leadH) tl.from(leadH, { y: 30, opacity: 0, duration: 0.6, ease: 'power2.out' });
          if(leadP) tl.from(leadP, { y: 24, opacity: 0, duration: 0.6, ease: 'power2.out' }, '-=0.3');
          break;
        default:
          if(title) tl.from(title, { y: 40, opacity: 0, duration: 0.6, ease: 'power2.out' });
          if(body) tl.from(body, { y: 20, opacity: 0, duration: 0.6, ease: 'power2.out' }, '-=0.3');
      }
    }

    // Init tekenen per scene met scrollama + tekstanimaties
    window.addEventListener('scroll', maybeActivateCloudFallback, { passive: true });
    window.addEventListener('resize', maybeActivateCloudFallback);
    setTimeout(maybeActivateCloudFallback, 400);
    window.addEventListener('scroll', maybeRevealQuoteFallback, { passive: true });
    window.addEventListener('resize', maybeRevealQuoteFallback);
    setTimeout(maybeRevealQuoteFallback, 500);

    document.addEventListener('DOMContentLoaded', function() {
      // Tekst-animaties voor alle scenes (alleen als GSAP beschikbaar)
      if (window.gsap) {
        document.querySelectorAll('section.step').forEach(animateTextForSection);
      } else {
        // Zonder GSAP: maak alle hidden elementen zichtbaar
        document.querySelectorAll('.hidden').forEach(d => d.classList.add('visible'));
      }

      scroller.setup({ step: '.step', offset: 0.5 }).onStepEnter(resp => {
        const el = resp.element; el.querySelectorAll('.hidden').forEach(d => d.classList.add('visible'));
        if (!el.classList.contains('drawn')) {
          if (el.id === 'scene1') drawTreemap('#vis1',[
            {label:'Sylvester',value:28},{label:'TM Communicatie Jaar 1',value:40},{label:'Testlabo Gen AI on Target',value:32},
            {label:'Roularta',value:18},{label:'DexVille / FCR Media',value:24},{label:'Dazzle Events',value:6},
            {label:'The Oval Office',value:6},{label:'Ferm',value:47}
          ]);
          if (el.id === 'scene2') drawDonut('#vis2',[
            {label:'Superfan',value:52},{label:'Maximalist',value:34},{label:'Observeerder',value:6},{label:'Underdog',value:5},{label:'Rebel',value:2}
          ]);
          if (el.id === 'scene3') drawDonut('#vis3',[
            {label:'Comfortabel',value:3},{label:'Afwachtend',value:10},{label:'Onzeker',value:6}
          ]);
          if (el.id === 'scene4') drawSankey('#vis4',[
            {name:'Comfortabel voor'},{name:'Afwachtend voor'},{name:'Onzeker voor'},{name:'Comfortabel na'},{name:'Afwachtend na'},{name:'Onzeker na'}],
            [{source:0,target:3,value:2},{source:0,target:4,value:1},{source:1,target:3,value:5},{source:1,target:4,value:3},{source:1,target:5,value:2},{source:2,target:3,value:5},{source:2,target:4,value:2},{source:2,target:5,value:2}]
          );
          if (el.id === 'scene5') drawDonut('#vis5',[
            {label:'3 sterren',value:11},{label:'4 sterren',value:29},{label:'5 sterren',value:21}
          ]);
          if (el.id === 'scene6') { if (window.gsap && window.ScrollTrigger) setupScene6(); }
          el.classList.add('drawn');
        }
      });
      window.addEventListener('resize', scroller.resize);
    });
  </script>
</body>
</html>
